<!-- Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="salesforceContactForm" action="https://webto.salesforce.com/servlet/servlet.WebToLead?encoding=UTF-8&orgId=00Df4000000oE8m" method="POST" data-turbo="false" data-remote="false">

        <input type="hidden" name="oid" value="00Df4000000oE8m">
        <input type="hidden" name="retURL" value="https://roperlawyers.com/thank-you">
        <input type="hidden" id="00NNt000004etQ5" name="00NNt000004etQ5" value="1" checked>

        <div class="modal-header">
          <h5 class="modal-title">Get In Touch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="text" name="first_name" class="form-control" id="first_name" maxlength="40" required placeholder="John" autocomplete="given-name">
            <label for="first_name">First Name *</label>
          </div>
          
          <!-- Honeypot field - hidden from users but visible to bots -->
          <div style="position: absolute; left: -9999px; opacity: 0; height: 0; overflow: hidden;">
            <input type="text" name="last_name" id="last_name" value="" autocomplete="off" tabindex="-1">
            <label for="last_name">Last Name (leave blank)</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" name="email" class="form-control" id="email" maxlength="80" required placeholder="name@example.com" autocomplete="email">
            <label for="email">Email *</label>
          </div>
          <div class="form-floating mb-3">
            <input type="tel" name="phone" class="form-control" id="phone" maxlength="40" placeholder="+34 123 456 789" autocomplete="tel">
            <label for="phone">Phone (include country code)</label>
          </div>
          <div class="form-floating mb-3">
            <textarea name="description" class="form-control" placeholder="Tell us about your legal requirements..." id="description" style="height: 120px" required></textarea>
            <label for="description">Description *</label>
          </div>
          
          <!-- Invisible reCAPTCHA -->
          <div class="g-recaptcha" 
               data-sitekey="6Le1R9UrAAAAAEpk0m5v-dUwbY9W9hKgyzaNZLgH" 
               data-callback="onRecaptchaSuccess" 
               data-size="invisible"></div>
          <p class="text-center text-muted small">We'll never share your info with anyone.</p>
        </div>
        
        <div class="modal-footer">
          <button type="submit" class="btn rounded-pill" style="background-color: #b39c84; border-color: #b39c84; color: white;">
            Send Message
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Global variables for form submission
let formSubmissionPending = false;

// Callback function for when invisible reCAPTCHA is successful
function onRecaptchaSuccess(token) {
  console.log('reCAPTCHA completed successfully');
  const form = document.getElementById('salesforceContactForm');
  
  if (form && formSubmissionPending) {
    formSubmissionPending = false;
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Sending...';
    submitBtn.disabled = true;
    
    // Create a hidden iframe to submit the form
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.name = 'salesforceFrame';
    document.body.appendChild(iframe);
    
    // Set the form target to the iframe
    form.target = 'salesforceFrame';
    
    // Submit the form to Salesforce in the background
    form.submit();
    
    // Close the modal and redirect after a short delay
    setTimeout(function() {
      console.log('Redirecting to thank you page...'); // Debug log
      
      // Try multiple ways to close the modal
      const modalElement = document.getElementById('contactModal');
      
      // Method 1: Try Bootstrap 5 API
      if (window.bootstrap && window.bootstrap.Modal) {
        const modal = window.bootstrap.Modal.getInstance(modalElement);
        if (modal) {
          modal.hide();
        }
      }
      
      // Method 2: Try jQuery if available (fallback)
      if (window.$ && window.$.fn.modal) {
        window.$('#contactModal').modal('hide');
      }
      
      // Method 3: Manual close (fallback)
      if (modalElement) {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
          backdrop.remove();
        }
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
      
      // Redirect to thank you page
      window.location.href = '/thank-you';
      
      // Clean up the iframe
      if (document.body.contains(iframe)) {
        document.body.removeChild(iframe);
      }
    }, 1500);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('salesforceContactForm');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      console.log('Form submission initiated - triggering invisible reCAPTCHA');
      
      // Check honeypot field first (bot detection)
      const honeypotField = form.querySelector('#last_name');
      if (honeypotField && honeypotField.value.trim() !== '') {
        console.log('Bot detected - honeypot field filled');
        return; // Silently fail for bots
      }
      
      // Validate form fields
      const firstNameField = form.querySelector('#first_name');
      const emailField = form.querySelector('#email');
      const descriptionField = form.querySelector('#description');
      
      if (!firstNameField.value.trim()) {
        alert('Please enter your first name.');
        firstNameField.focus();
        return;
      }
      
      if (!emailField.value.trim()) {
        alert('Please enter your email address.');
        emailField.focus();
        return;
      }
      
      if (!descriptionField.value.trim()) {
        alert('Please enter a description of your legal requirements.');
        descriptionField.focus();
        return;
      }
      
      // Set flag to indicate form submission is pending
      formSubmissionPending = true;
      
      // Execute invisible reCAPTCHA
      grecaptcha.execute();
    });
  } else {
    console.log('Form not found!'); // Debug log
  }
});
</script>
