<!-- Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <%= form_with model: Contact.new, url: contacts_path, id: "railsContactForm", local: false do |form| %>

        <div class="modal-header">
          <h5 class="modal-title">Get In Touch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="form-floating mb-3">
            <%= form.email_field :email, class: "form-control", id: "email", required: true, placeholder: "name@example.com", autocomplete: "email" %>
            <label for="email">Email *</label>
          </div>
          <div class="form-floating mb-3">
            <%= form.text_area :message, class: "form-control", placeholder: "Tell us about your legal requirements...", id: "message", style: "height: 120px", required: true %>
            <label for="message">Message *</label>
          </div>
          
          <!-- Honeypot field - hidden from users but visible to bots -->
          <div style="position: absolute; left: -9999px; opacity: 0; height: 0; overflow: hidden;">
            <input type="text" name="last_name" id="last_name" value="" autocomplete="off" tabindex="-1">
            <label for="last_name">Last Name (leave blank)</label>
          </div>
          
          <p class="text-center text-muted small">We'll never share your info with anyone.</p>
        </div>
        
        <div class="modal-footer">
          <%= form.submit "Send Message", class: "btn rounded-pill", style: "background-color: #b39c84; border-color: #b39c84; color: white;" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('railsContactForm');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      console.log('Rails contact form submitted');
      
      // Check honeypot field first (bot detection)
      const honeypotField = form.querySelector('#last_name');
      if (honeypotField && honeypotField.value.trim() !== '') {
        console.log('Bot detected - honeypot field filled');
        return; // Silently fail for bots
      }
      
      // Validate form fields
      const emailField = form.querySelector('#email');
      const messageField = form.querySelector('#message');
      
      if (!emailField.value.trim()) {
        alert('Please enter your email address.');
        emailField.focus();
        return;
      }
      
      if (!messageField.value.trim()) {
        alert('Please enter your message.');
        messageField.focus();
        return;
      }
      
      // Show loading state
      const submitBtn = form.querySelector('input[type="submit"]');
      const originalValue = submitBtn.value;
      submitBtn.value = 'Sending...';
      submitBtn.disabled = true;
      
      // Prepare form data
      const formData = new FormData(form);
      
      // Submit form via fetch
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Email sent successfully!');
          
          // Close the modal
          const modalElement = document.getElementById('contactModal');
          
          // Method 1: Try Bootstrap 5 API
          if (window.bootstrap && window.bootstrap.Modal) {
            const modal = window.bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
          }
          
          // Method 2: Try jQuery if available (fallback)
          if (window.$ && window.$.fn.modal) {
            window.$('#contactModal').modal('hide');
          }
          
          // Show success message
          alert('Thank you for your message! We\'ll get back to you soon.');
          
          // Reset form
          form.reset();
          
        } else {
          console.error('Form submission failed:', data.errors);
          alert('There was an error sending your message. Please check your information and try again.');
        }
        
        // Reset button
        submitBtn.value = originalValue;
        submitBtn.disabled = false;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('There was an error sending your message. Please try again.');
        
        // Reset button
        submitBtn.value = originalValue;
        submitBtn.disabled = false;
      });
    });
  } else {
    console.log('Rails form not found!');
  }
});
</script>
